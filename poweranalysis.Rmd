---
title: "Poweranalysis"
author: "CK"
date: "24/08/2020"
output: 
 bookdown::html_document2:
  fig_caption: yes
  toc: yes
  toc_float: true
  number_sections: false
 bookdown::word_document2:
 bookdown::pdf_document2:
   keep_tex: true
editor_options: 
  chunk_output_type: console
#always_allow_html: true
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
  encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
  
  
  
---

# The data set  
The data consists of measurements of 36 pasture-soil samples (0－10cm) which are historically contaminated with dieldrin residues. Dieldrin is extremely persistent and therefore still found in the surface soil after three decades of natural attenuation.  
  
The samples were taken in 12 paddocks in two different soils, with three field replicates at representative areas of each paddock. So overall the data consists of:   
  
- 2 soils
  - 12 paddocks (7 + 5)
    - 36 samples (3 per paddock, 21 + 15)  
  
Total dieldrin loss (%) since 24-30 years was recorded per paddock. Thus, dieldrin residue concentrations (µg/g soil) and other soil measurements were measured for all samples (n = 36) but dieldrin loss (%) was available per paddock only (n = 12). 
  
**Data table (n = 36):**
```{r setup, include=TRUE, message=FALSE, echo=FALSE}
library(tidyverse)
library(rcompanion)
library(pwr)
library(rstatix)

# Get some data
metadata<- readr::read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run/metadata.tsv") 

# Change to your liking
metadata2 <- metadata[c(2:nrow(metadata)),c(1:length(metadata))] %>%
  tibble::rownames_to_column("spl") %>%
  dplyr::mutate_all(type.convert) %>%
  dplyr::mutate_if(is.factor, as.character) %>%
  tibble::column_to_rownames("spl")

metadata2$Soil <- recode_factor(metadata2$Soil, '1' = 'Kurosol', '2' = 'Chromosol')

# Some rows and 10 columns as overview of data. Only some of the measurements are shown.
options(knitr.kable.NA = '')
kableExtra::kable(metadata2[c(1:5,22:27),c(1:4,6,10,11,13,14,15,17)]) %>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )
```
  
## Dieldrin concentrations  
**Dieldrin concentrations (n=36) were approximately log-normal**
```{r shapiro, include=TRUE, message=FALSE, echo=FALSE}  
# Test normality of dieldrin concentrations n = 36
shapiro.test(log10(metadata2$D1517))  # aprox lognormal
```
  

**Distribution of dieldrin concentrations (log-scale)**
```{r boxplots, include=TRUE, message=FALSE, echo=TRUE, fig.width=8, fig.asp=0.6} 
# Boxplot of dieldrin concentrations across all 36 samples and then by soil type
p1 <- metadata2 %>% ggpubr::ggboxplot(y = "D1517", add="jitter", ylab = "Dieldrin concentrations (µg/g soil)", add.params = list(shape = "Soil"), yscale = "log10")

p2 <- metadata2 %>% ggpubr::ggboxplot(y = "D1517", x = "Soil", add="jitter", ylab = "Dieldrin concentrations (µg/g soil)", shape = "Soil", yscale = "log10")

ggpubr::ggarrange(p1, p2)
```

  
**Dieldrin concentrations per soil and paddock:**
```{r dieldrincc, include=TRUE, message=FALSE, echo=FALSE}


options(knitr.kable.NA = '')
kableExtra::kable(metadata2 %>%
  group_by(Soil) %>%
  get_summary_stats(D1517, type = "mean_se") %>% rename(Dieldrin = variable ) ) %>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )


# Mean dieldrin concentrations per paddock
options(knitr.kable.NA = '')
kableExtra::kable(metadata2 %>%
  group_by(Paddock) %>%
  get_summary_stats(D1517, type = "mean_se")  %>% rename(Dieldrin = variable ) )%>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )
```
  
## Total dieldrin loss (%)

**Dieldrin losses (%) since 1988  were approximately normal (n=12)**
```{r shapiroloss, include=TRUE, message=FALSE, echo=FALSE}  
# Test normality of dieldrin concentrations n = 36

metadata2 %>%
  group_by(Paddock) %>% summarise(Dloss = mean(Dloss)) %>%  rstatix::shapiro_test(Dloss)

```

**Distribution of dieldrin loss (%)**
```{r boxplotsloss, include=TRUE, message=FALSE, echo=TRUE, fig.width=8, fig.asp=0.6} 
# Boxplot of dieldrin concentrations across all 36 samples and then by soil type
p1 <- metadata2 %>%  group_by(Soil, Paddock) %>% summarise(Dloss = mean(Dloss)) %>% ggpubr::ggboxplot(y = "Dloss", add="jitter", ylab = "Dieldrin loss (%)", add.params = list(shape = "Soil"))

p2 <-  metadata2 %>%  group_by(Soil, Paddock) %>% summarise(Dloss = mean(Dloss)) %>% ggpubr::ggboxplot(y = "Dloss", x = "Soil", add="jitter", ylab = "Dieldrin loss (%)", add.params = list(shape = "Soil"))

ggpubr::ggarrange(p1, p2)
```

**Total dieldrin loss since 1988 (%) per soil and paddock:**  
Total dieldrin loss was recorded per paddock only (n = 12)
```{r dieldrinloss, include=TRUE, message=FALSE, echo=FALSE}  

kableExtra::kable(metadata2 %>%
  group_by(Soil) %>%
  get_summary_stats(Dloss, type = "mean_se")  %>% rename(Dieldrinloss = variable )) %>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )


# Mean dieldrin losses per paddock
# There is no standard error within each paddock - as the values for dieldrin loss were collected per paddock, not per sample
kableExtra::kable(metadata2 %>%
  group_by(Paddock) %>%
  get_summary_stats(Dloss, type = "mean_se")  %>% rename(Dieldrinloss = variable )) %>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )

```
  

# Questions  
  
- From the available 36 samples (21 for soil 1 and 15 for soil 2), how much power does the mean have for each soil?
- How many samples are needed per sample to get the true mean of dieldrin concentrations per sample? 

# Confidence intervals (bootstrapped)
```{r ce, include=TRUE, message=FALSE, echo=TRUE}


# Get bootstrapped confidence interval - this time for dieldrin concentrations per sample.
rcompanion::groupwiseMean(D1517 ~ 1, data = metadata2, conf = 0.95, digits = 3,
                          boot = FALSE, R = 1000)

rcompanion::groupwiseMean(D1517 ~ Soil, data = metadata2, conf = 0.95, digits = 3,
                          boot = FALSE, R = 1000)

# Group data by paddock and select dieldrin loss - n = 12
meandata <- metadata2 %>% group_by(Soil, Paddock) %>% summarise(Dlossmean = mean(Dloss))
meandata %>% group_by(Soil) %>% get_summary_stats(Dlossmean, type = "mean_se")

# Test normality of dieldrin loss n = 12
shapiro.test(meandata$Dlossmean)

# Get bootstrapped confidence interval of dieldrin loss per paddock
rcompanion::groupwiseMean(Dlossmean ~ 1, data = meandata, conf = 0.95, digits = 3,
              boot = TRUE, R = 1000)



```

# Power analysis with pwr package
```{r power, include=TRUE, message=FALSE, echo=TRUE}
# Calculate the number of samples needed to model Dlossmean (12 samples) with CN as predictor
# https://cran.r-project.org/web/packages/pwr/vignettes/pwr-vignette.html
# The effect size is the R2 of the model. the coefficient of determination, aka the “proportion of variance explained”
pwr.f2.test(u = 1, f2 = 0.5/(1 - 0.5), sig.level = 0.001, power = 0.8)
#n = v + u + 1
# n = 21 + 1 + 1 = 22 paddocks needed at an effec size of 0.5


# samples (n) needed for a rubust mean
#http://r-video-tutorial.blogspot.com/2017/07/power-analysis-and-sample-size.html
# n = ((2 x STD) / SE )^2
data <- metadata2 %>% group_by(Paddock) %>% summarise(Dlossmean = mean(Dloss), CNmean = mean(CN))
sum_stat <- data %>% rstatix::get_summary_stats(Dlossmean, show = c("mean", "sd", "se"))
n = ( (2 * sum_stat$sd) / sum_stat$se )^2
# n = 48 samples needed for the mean dieldrin loss  to be robust
n 
```

# Resample examples
Resample 1000x and calculate mean and std of dieldrin concentrations
```{r resampleexample, include=TRUE, message=FALSE, warning=FALSE, fig.width=17, fig.asp=0.4, cache=TRUE}

# Notes 

#calc mean and std 1000 x
# calc distr. of means and std
# variation from the mean
# sample size less 30 - t distribution
# look up the table
# simulations

resample = 1000
measurement = 'D1517'

# The mean mean function
meanfunction <- function(df){
df %>% rstatix::get_summary_stats(measurement, type = "mean")  
}

# Function to randomly resample the mean 1000x with replacement and get a df with the mean of each resample
# Do this once as this takes time and do not repeat for histogram
listfunction <- function(df){
listdf <- replicate(resample, dplyr::slice_sample(df, n= n, replace = TRUE), simplify = FALSE) %>%
  lapply(., meanfunction) %>% 
  bind_rows  
return(listdf)
}

# Function to get a summary statistic of the mean
summaryfunction <- function(listdf){
  listdf %>% rstatix::get_summary_stats(mean, type = "common")
}


# Function to get a historgram of the means
histofunction <- function(summarydf){
plotting <- summaryfunction(summarydf)
  summarydf %>% ggpubr::gghistogram(x= "mean", title = paste(resample,"x resampled with n =", n, ", mean =", plotting$mean, "stdv =", plotting$sd))
}


# n=10
n = 10 # number of samples to resample every time 
set.seed(111)
summarydf <- listfunction(metadata2)
summaryfunction(summarydf)
p10 <- histofunction(summarydf)

# n=15
n = 15 # number of samples to resample every time 
set.seed(111)
summarydf <- listfunction(metadata2)
summaryfunction(summarydf)
p15 <- histofunction(summarydf)

# n=20
n = 20 # number of samples to resample every time 
set.seed(111)
summarydf <- listfunction(metadata2)
summaryfunction(summarydf)
p20 <- histofunction(summarydf)

ggpubr::ggarrange(p10, p15, p20, nrow = 1)
```

